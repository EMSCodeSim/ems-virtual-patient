<!-- (everything before remains unchanged) -->

<script>
  let userTranscript = [];
  let scenarioActive = false;
  let totalTime = 15 * 60;
  let countdown;
  let mediaTriggers = [];

  // âœ… NEW: Track if patient_1.jpg has been shown
  let hasPatient1Shown = false;

  async function loadScenarioData(scenarioName) {
    const basePath = `/scenarios/${scenarioName}`;

    try {
      const [dispatchRes, metadataRes, vitalsRes, triggersRes] = await Promise.all([
        fetch(`${basePath}/dispatch.txt`),
        fetch(`${basePath}/metadata.json`),
        fetch(`${basePath}/vitals.json`),
        fetch(`${basePath}/media_triggers.json`)
      ]);

      const dispatchText = await dispatchRes.text();
      const metadata = await metadataRes.json();
      const vitals = await vitalsRes.json();
      const triggerData = await triggersRes.json();

      mediaTriggers = triggerData.triggers || [];

      document.getElementById('chat-display').innerHTML = '';
      addChatMessage(`ðŸ“Ÿ Dispatch: ${dispatchText}`);
      addChatImage(`${basePath}/${metadata.media.scene}`, "Scene Photo");

      window.currentScenario = {
        metadata,
        vitals,
        basePath
      };

      scenarioActive = true;
      hasPatient1Shown = false; // Reset at start
      startTimer();

    } catch (err) {
      console.error("Error loading scenario:", err);
      alert("Failed to load scenario.");
    }
  }

  function startTimer() {
    const timerBtn = document.getElementById('start-button');
    timerBtn.disabled = true;

    countdown = setInterval(() => {
      const mins = Math.floor(totalTime / 60);
      const secs = totalTime % 60;
      timerBtn.textContent = 'ðŸ•’ ' + String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
      totalTime--;

      if (totalTime < 0) {
        clearInterval(countdown);
        timerBtn.textContent = 'â° Time is up!';
        scenarioActive = false;
        endScenario();
      }
    }, 1000);
  }

  function startScenario() {
    loadScenarioData("chest_pain_01");
    userTranscript = [];
    totalTime = 15 * 60;
  }

  async function sendMessage(messageOverride = null) {
    const input = document.getElementById('user-input');
    const message = messageOverride || input.value.trim();
    if (!message) return;

    addChatMessage(message);
    checkMediaTriggers(message);
    userTranscript.push("User: " + message);
    input.value = '';

    try {
      const response = await fetch('/.netlify/functions/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });

      const data = await response.json();
      const reply = data?.reply || 'âš ï¸ No response received from patient.';
      addChatMessage(reply);

      // âœ… Trigger patient_1.jpg only on first GPT-4 reply
      if (!hasPatient1Shown && reply !== 'âš ï¸ No response received from patient.') {
        if (window.currentScenario) {
          addChatImage(`${window.currentScenario.basePath}/patient_1.jpg`, "Patient contact made");
          hasPatient1Shown = true;
        }
      }

    } catch (err) {
      console.error(err);
      addChatMessage("âš ï¸ Error communicating with AI.");
    }
  }

  function addChatMessage(text) {
    const chat = document.getElementById('chat-display');
    const div = document.createElement('div');
    div.className = 'chat-message';
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function addChatImage(src, altText = '') {
    const chat = document.getElementById('chat-display');
    const wrapper = document.createElement('div');
    wrapper.className = 'chat-message';
    const img = document.createElement('img');
    img.src = src;
    img.alt = altText;
    wrapper.appendChild(img);
    chat.appendChild(wrapper);
    chat.scrollTop = chat.scrollHeight;
  }

  function checkMediaTriggers(message) {
    if (!mediaTriggers.length || !window.currentScenario) return;

    mediaTriggers.forEach(trigger => {
      if (message.toLowerCase().includes(trigger.onPhrase.toLowerCase())) {
        const filePath = `${window.currentScenario.basePath}/${trigger.file}`;
        if (trigger.type === "image") {
          addChatImage(filePath, trigger.file);
        } else if (trigger.type === "audio") {
          const audio = new Audio(filePath);
          audio.play();
        }
      }
    });
  }

  function endScenario() {
    scenarioActive = false;
    clearInterval(countdown);
    document.getElementById('start-button').textContent = 'â¹ Scenario Ended';

    addChatMessage('ðŸš‘ Scenario ended. Preparing summary and feedback...');
    const transcript = userTranscript.join("\n");

    fetch('/.netlify/functions/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ message: `[END SCENARIO]\n${transcript}` })
    })
      .then(res => res.json())
      .then(data => addChatMessage(data?.reply || 'âš ï¸ No final report received.'))
      .catch(err => {
        console.error(err);
        addChatMessage("âš ï¸ Error generating final report.");
      });
  }

  function startVoiceInput() {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = function(event) {
      const speechResult = event.results[0][0].transcript;
      sendMessage(speechResult);
    };

    recognition.onerror = function(event) {
      alert('Mic error: ' + event.error);
    };

    recognition.start();
  }

  // âŒ¨ï¸ Enable "Enter" to send message
  document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("user-input");
    input.addEventListener("keypress", function (event) {
      if (event.key === "Enter" && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    });
  });
</script>
</body>
</html>
